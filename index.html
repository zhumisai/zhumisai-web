<script src="./js/base64.min.js"></script>
<!-- <script src="https://github.com/octokit/.*"></script> -->

<body>
    <!-- 上传文件:  <input type="file" id="fileInput"></input><br/> -->
    token: <input type="txt" id="authToken"></input><br />
    <br />
    <button type="button" id="fileOutput">上传</button><br />
</body>

<script type="module">
    import { Octokit } from "https://esm.sh/octokit";
    // import { Base64 } from 'https://github.com/dankogai/js-base64'

 

    const fileOutput = document.getElementById('fileOutput');

    fileOutput.addEventListener('click', (e) => {
        upload("hello,world,hello,kitty")
    });


    async function upload(fileString) {
        let authToken = document.getElementById('authToken').value;
        console.log(authToken)
        let octokit = new Octokit({ auth: authToken });
        // 
        let response = await octokit.request('GET /repos/zhumisai/zhumisai-web/contents/asset/data.csv', {
            // owner: 'zhumisai',
            // repo: 'zhumisai-web',
            // path: 'data.csv',
            headers: {
                'X-GitHub-Api-Version': '2022-11-28'
            }
        })
        checkOctokitResponse(response)
        console.log(response)

        let resposne2 = await octokit.request('PUT /repos/zhumisai/zhumisai-web/contents/asset/data.csv', {
            // owner: 'zhumisai',
            // repo: 'zhumisai-web',
            // path: 'data.csv',
            message: 'commit data.csv',
            committer: {
                name: 'from_browser',
                email: 'guest_abc@github.com'
            },
            sha: response.data.sha,
            content: Base64.encode(fileString),
            headers: {
                'X-GitHub-Api-Version': '2022-11-28'
            }
        })
        checkOctokitResponse(resposne2)
        // fetch('https://api.github.com/repos/zhumisai/zhumisai-web/contents/asset/data.csv', {
        //     method: 'put',
        //     body: JSON.stringify({
        //         "message": "commit data.csv",
        //         "committer": {
        //             "name": "from_browser",
        //             "email": "guest_abc@github.com"
        //         },
        //         "content": "aGVsbG8sd29ybGQsaGVsbG8sa2l0dHk=",
        //         "sha": response.sha
        //     }),
        //     headers: {
        //         'Content-Type': 'application/json',
        //         'Authorization': 'Bearer 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',
        //         'X-Github-Api-Version': '2022-11-28',
        //         'Accept':'application/vnd.github.v3+json'
        //     }
        // })
        //     .then(function (data) {
        //         return data.text();
        //     }).then(function (data) {
        //         console.log(data)
        //     });
    }

    function checkOctokitResponse(response){
        if(!response){
            alert("错误")
        } else if(response.status != 200){
            alert("错误码("+response.status+"), 联系网站管理员")
        }
    }
</script>